CREATE DATABASE AGENCIA6;
USE AGENCIA6;

CREATE TABLE FUNCIONARIO(
	IDFUNC INT PRIMARY KEY AUTO_INCREMENT,
	NOMEFUNC VARCHAR(50) NOT NULL,
	EMAIL VARCHAR(50) NOT NULL UNIQUE,
	SENHA VARCHAR(100) NOT NULL,
	CPF VARCHAR(11) NOT NULL UNIQUE,
	ID_DEP INT NOT NULL,
	CARGO VARCHAR(30) NOT NULL
	);
	
CREATE TABLE DEPARTAMENTO(
	IDDEP INT PRIMARY KEY AUTO_INCREMENT,
	NOMEDEP VARCHAR(50) NOT NULL,
	ORCAMENTO FLOAT(10,2) NOT NULL,
	ID_GERENTE INT
	);

ALTER TABLE FUNCIONARIO	
ADD CONSTRAINT FK_DEPARTAMENTO_FUNCIONARIO
FOREIGN KEY (ID_DEP)
REFERENCES DEPARTAMENTO(IDDEP);

CREATE TABLE VALORES(
	IDVAL INT PRIMARY KEY AUTO_INCREMENT,
	LOCALDEST CHAR(5) NOT NULL UNIQUE,
	VALORDEST FLOAT(10,2) NOT NULL
	);
	
INSERT INTO VALORES VALUES (NULL, 'BAAVI', 1430.25);
INSERT INTO VALORES VALUES (NULL, 'TOAVI', 3450.32);
INSERT INTO VALORES VALUES (NULL, 'ONAVI', 9830.48);
INSERT INTO VALORES VALUES (NULL, 'SPAVI', 6530.87);
INSERT INTO VALORES VALUES (NULL, 'SPHOT', 930.32);
INSERT INTO VALORES VALUES (NULL, 'TOHOT', 432.94);
INSERT INTO VALORES VALUES (NULL, 'SPCAR', 988.55);
INSERT INTO VALORES VALUES (NULL, 'ONCAR', 739.64);
INSERT INTO VALORES VALUES (NULL, 'BAHOT', 534.26);
	
CREATE TABLE SOLICITA(
	IDSOLIC INT PRIMARY KEY AUTO_INCREMENT,
	DATASOLIC DATE NOT NULL,
	ID_FUNC INT NOT NULL,
	ID_AGENCIA INT NOT NULL,
	ID_VAL INT,
	JUSTIFICATIVA VARCHAR(140) NOT NULL,
	TIPO ENUM('1', '2', '3') NOT NULL,
	DTINICIO DATE NOT NULL,      			/*-----------------------------------------------------------------------------------------------16/10 */	
	DTFIM DATE NOT NULL						/*-----------------------------------------------------------------------------------------------16/10 */
	);
	
ALTER TABLE SOLICITA
ADD CONSTRAINT FK_VALORES_SOLICITA
FOREIGN KEY (ID_VAL)
REFERENCES VALORES(IDVAL);
	
CREATE TABLE AGENCIA(
	IDAGENCIA INT PRIMARY KEY AUTO_INCREMENT,
	NOME VARCHAR(30) NOT NULL,
	CNPJ INT UNIQUE NOT NULL
	);
	
ALTER TABLE SOLICITA
ADD CONSTRAINT FK_FUNCIONARIO_SOLICITA
FOREIGN KEY (ID_FUNC)
REFERENCES FUNCIONARIO(IDFUNC);

ALTER TABLE SOLICITA
ADD CONSTRAINT FK_AGENCIA_SOLICITA
FOREIGN KEY (ID_AGENCIA)
REFERENCES AGENCIA(IDAGENCIA);

CREATE TABLE APROVACAO(
	IDAPROV INT PRIMARY KEY AUTO_INCREMENT,
	ID_SOLIC INT NOT NULL,
	VALOR INT NOT NULL,
	APROV ENUM('S','N','P') NOT NULL DEFAULT 'P' /* S = Sim // N = Não // P = Pendente */
	);

ALTER TABLE APROVACAO
ADD CONSTRAINT FK_SOLICITA_APROVACAO
FOREIGN KEY (ID_SOLIC)
REFERENCES SOLICITA(IDSOLIC);

CREATE TABLE PASSAGEM(
	IDPASS INT PRIMARY KEY AUTO_INCREMENT,
	NUMIDENT INT NOT NULL UNIQUE,
	ID_APROV INT NOT NULL
	/*DTINICIO DATE NOT NULL,
	DTFIM DATE NOT NULL             ----------------------------------------------------------------------------------------------------16/10 */
 	);
	
ALTER TABLE PASSAGEM
ADD CONSTRAINT FK_APROVACAO_PASSAGEM
FOREIGN KEY (ID_APROV)
REFERENCES APROVACAO(IDAPROV);	

CREATE TABLE HOTEL(
	IDHOTEL INT PRIMARY KEY AUTO_INCREMENT,
	NOMEHOTEL VARCHAR(50) NOT NULL,
	CNPJ INT NOT NULL UNIQUE
	);
	
CREATE TABLE HOSPEDAGEM(
	IDHOSP INT PRIMARY KEY AUTO_INCREMENT,
	ID_PASS INT NOT NULL UNIQUE,
	ID_HOTEL INT NOT NULL,
	NUMQUARTO INT NOT NULL
	);
	
ALTER TABLE HOSPEDAGEM
ADD CONSTRAINT FK_HOTEL_HOSPEDAGEM
FOREIGN KEY (ID_HOTEL)
REFERENCES HOTEL(IDHOTEL);

ALTER TABLE HOSPEDAGEM
ADD CONSTRAINT FK_PASSAGEM_HOSPEDAGEM
FOREIGN KEY (ID_PASS)
REFERENCES PASSAGEM(IDPASS);
	
CREATE TABLE COMPANHIAEREA(
	IDCOMP INT PRIMARY KEY AUTO_INCREMENT,
	NOMECOMP VARCHAR(50) NOT NULL,
	CNPJ INT NOT NULL UNIQUE
	);
	
CREATE TABLE AEREA(
	IDAEREA INT PRIMARY KEY AUTO_INCREMENT,
	ID_PASS INT NOT NULL UNIQUE,
	ID_COMP INT NOT NULL,
	LOCALIZADOR INT NOT NULL,
	ASSENTO VARCHAR(5) NOT NULL
	);
	
ALTER TABLE AEREA
ADD CONSTRAINT FK_COMPANHIAREA_AEREA
FOREIGN KEY (ID_COMP)
REFERENCES COMPANHIAEREA(IDCOMP);

ALTER TABLE AEREA
ADD CONSTRAINT FK_PASSAGEM_AEREA
FOREIGN KEY (ID_PASS)
REFERENCES PASSAGEM(IDPASS);

CREATE TABLE LOCADORA(
	IDLOCADORA INT PRIMARY KEY AUTO_INCREMENT,
	NOMELOCADORA VARCHAR(50) NOT NULL,
	CPNJ INT NOT NULL UNIQUE
	);
	
CREATE TABLE LOCACAO(
	IDLOCACAO INT PRIMARY KEY AUTO_INCREMENT,
	ID_PASS INT NOT NULL UNIQUE,
	ID_LOCADORA INT NOT NULL,
	MODELOVEIC VARCHAR(50) NOT NULL,
	PLACA VARCHAR(8) NOT NULL
	);

ALTER TABLE LOCACAO
ADD CONSTRAINT FK_LOCADORA_LOCACAO
FOREIGN KEY (ID_LOCADORA)
REFERENCES LOCADORA(IDLOCADORA);

ALTER TABLE LOCACAO
ADD CONSTRAINT FK_PASSAGEM_LOCACAO
FOREIGN KEY (ID_PASS)
REFERENCES PASSAGEM(IDPASS);

INSERT INTO DEPARTAMENTO VALUES(NULL, 'TI', 5000,NULL);
INSERT INTO FUNCIONARIO VALUES(NULL, 'JOAO', 'JOAO@GMAIL.COM', 'JAOA123',04534625126,1,'SECRETARIO');
INSERT INTO FUNCIONARIO VALUES(NULL, 'GABRIEL', 'GABRIEL@GMAIL.COM', 'GABRIEL123',46889425126,1,'SECRETARIO');

SELECT COUNT(*) FROM FUNCIONARIO
WHERE EMAIL = 'JOAO@GMAIL.COM' AND SENHA = 'JAOA123';

DELIMITER $

CREATE PROCEDURE LOGIN(EMAIL1 VARCHAR(50), SENHA1 VARCHAR(100))
BEGIN
	SELECT COUNT(*) FROM FUNCIONARIO
	WHERE EMAIL = EMAIL1 AND SENHA = SENHA1;
END$

CREATE PROCEDURE HISTORICO(EMAIL1 VARCHAR(50), SENHA1 VARCHAR(100))
BEGIN
	DECLARE IDFUNC1 INT;
	SET IDFUNC1 = ( 
		SELECT IDFUNC FROM FUNCIONARIO
		WHERE EMAIL = EMAIL1 AND SENHA = SENHA1);
	SELECT A.IDAPROV,S.ID_FUNC, S.JUSTIFICATIVA, LOCALDEST, A.VALOR, A.APROV, S.TIPO FROM APROVACAO AS A
	INNER JOIN SOLICITA AS S
	ON A.ID_SOLIC = S.IDSOLIC
	INNER JOIN VALORES AS V
	ON IDVAL = ID_VAL
	WHERE S.ID_FUNC = IDFUNC1;
END$

DELIMITER ;

INSERT INTO AGENCIA VALUES(NULL, 'EUPHORIA', 938472847);



UPDATE DEPARTAMENTO SET ID_GERENTE = 1
WHERE IDDEP = 1;

DELIMITER $

CREATE PROCEDURE PARAAPROVAR(EMAIL1 VARCHAR(50), SENHA1 VARCHAR(100))
BEGIN
	DECLARE IDFUNC1 INT;
	SET IDFUNC1 = ( 
		SELECT IDFUNC FROM FUNCIONARIO
		WHERE EMAIL = EMAIL1 AND SENHA = SENHA1);
	IF (IDFUNC1 IN (SELECT ID_GERENTE FROM DEPARTAMENTO))
		THEN
			SELECT A.IDAPROV,S.ID_FUNC, S.JUSTIFICATIVA, LOCALDEST, A.VALOR, A.APROV, S.TIPO FROM APROVACAO AS A
			INNER JOIN SOLICITA AS S
			ON A.ID_SOLIC = S.IDSOLIC
			JOIN VALORES
			ON IDVAL = ID_VAL
			JOIN FUNCIONARIO
			ON IDFUNC = ID_FUNC
			JOIN DEPARTAMENTO
			ON ID_GERENTE = IDFUNC
			WHERE ID_GERENTE = IDFUNC1 AND APROV = 'P';
		ELSE
			SELECT 'VOCE NAO POSSUI ACESSO A ESSA ABA' AS '';
	END IF;
END$

DELIMITER ;

DELIMITER $

CREATE PROCEDURE MEUHISTORICO(EMAIL1 VARCHAR(50), SENHA1 VARCHAR(100))
BEGIN
	DECLARE IDFUNC1 INT;
	SET IDFUNC1 = ( 
		SELECT IDFUNC FROM FUNCIONARIO
		WHERE EMAIL = EMAIL1 AND SENHA = SENHA1);
	SELECT IDAPROV, IDSOLIC, VALOR, JUSTIFICATIVA, SOLICITA.TIPO, APROV FROM APROVACAO
	JOIN SOLICITA
	ON IDSOLIC = ID_SOLIC
	WHERE ID_FUNC = IDFUNC1;
END$

CREATE PROCEDURE GASTOSFUNC(EMAIL1 VARCHAR(50), SENHA1 VARCHAR(100))
BEGIN
	DECLARE IDFUNC1 INT;
	SET IDFUNC1 = ( 
		SELECT IDFUNC FROM FUNCIONARIO
		WHERE EMAIL = EMAIL1 AND SENHA = SENHA1);
	IF (IDFUNC1 IN (SELECT ID_GERENTE FROM DEPARTAMENTO))
		THEN
			SELECT IDFUNC, NOMEFUNC, SUM(VALOR) AS 'TOTAL GASTO', EMAIL FROM APROVACAO
			JOIN SOLICITA
			ON ID_SOLIC = IDSOLIC
			JOIN FUNCIONARIO
			ON IDFUNC = ID_FUNC
			JOIN DEPARTAMENTO
			ON ID_DEP = IDDEP
			WHERE ID_GERENTE = IDFUNC1
			GROUP BY IDFUNC, NOMEFUNC;
		ELSE
			SELECT 'VOCE NAO POSSUI ACESSO A ESSA ABA' AS '';
	END IF;
END$
			
CREATE PROCEDURE NOVASOLICITACAO(EMAIL1 VARCHAR(50), SENHA1 VARCHAR(100), IDAGENCIA1 INT, LOCALDEST1 CHAR(5), TIPO1 ENUM('1', '2', '3'), JUSTIFICATIVA1 VARCHAR(140), DTINICIO1 DATE, DTFIM1 DATE)
BEGIN
	DECLARE IDFUNC1 INT;
	DECLARE IDVAL1 CHAR(5);
	SET IDVAL1 = (SELECT IDVAL FROM VALORES
					WHERE LOCALDEST = LOCALDEST1);
	SET IDFUNC1 = ( 
		SELECT IDFUNC FROM FUNCIONARIO
		WHERE EMAIL = EMAIL1 AND SENHA = SENHA1);
	INSERT INTO SOLICITA VALUES(NULL, NOW(), IDFUNC1, IDAGENCIA1, IDVAL1, JUSTIFICATIVA1, TIPO1, DTINICIO1, DTFIM1);
END$

CREATE PROCEDURE APROVAR(EMAIL1 VARCHAR(50), SENHA1 VARCHAR(100), IDAPROV1 INT, APROV1 ENUM('S','N','P'))
BEGIN
	DECLARE IDFUNC1 INT;
	SET IDFUNC1 = ( 
		SELECT IDFUNC FROM FUNCIONARIO
		WHERE EMAIL = EMAIL1 AND SENHA = SENHA1);
	IF (IDFUNC1 IN (SELECT ID_GERENTE FROM DEPARTAMENTO))
		THEN
			UPDATE APROVACAO SET APROV = APROV1
			WHERE IDAPROV = IDAPROV1;
		ELSE
			SELECT 'VOCE NAO POSSUI ACESSO A ESSA ABA' AS '';
	END IF;
END$

DELIMITER ;
/*-------14/10--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
DELIMITER $

CREATE PROCEDURE DELETASOLICITA(EMAIL VARCHAR(50), SENHA1 VARCHAR(100), IDSOLIC1 INT)
BEGIN
	DECLARE IDFUNC1 INT;
	SET IDFUNC1 = ( 
		SELECT IDFUNC FROM FUNCIONARIO
		WHERE EMAIL = EMAIL1 AND SENHA = SENHA1);
	IF (IDFUNC1 IN (SELECT ID_FUNC FROM SOLICITA WHERE IDSOLIC = IDSOLIC1))
		THEN
			DELETE FROM APROVACAO
				WHERE ID_SOLIC = IDSOLIC1;
			ELSE
				SELECT 'A SOLICITAÇÃO NÃO CORRESPONDE AO SEU ID' AS '';
	END IF;
END$

DELIMITER ;
	
/*-------16/10--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------*/	
DELIMITER $

CREATE TRIGGER SOLICITA_APROV                                                    
AFTER INSERT ON SOLICITA
FOR EACH ROW
BEGIN
	DECLARE VALOR1 INT;
	SET VALOR1 = (SELECT VALORDEST FROM VALORES WHERE IDVAL = NEW.ID_VAL);
	IF ( ('2' = (NEW.TIPO)) OR ('3' = (NEW.TIPO)))
	THEN
		SET VALOR1 = VALOR1*(DATEDIFF(NEW.DTFIM, NEW.DTINICIO));
	END IF;
	INSERT INTO APROVACAO VALUES(NULL, NEW.IDSOLIC, VALOR1, 'P');
END$

DELIMITER ;

/* FORMATO DE DATA = AAAAMMDD // A = ANO // M = MES // D=DIA */
CALL NOVASOLICITACAO('JOAO@GMAIL.COM', 'JAOA123', 1, 'SPAVI', '1', 'LULZ', 20191017, 20191025);

CREATE TABLE DELSOLIC(
	IDDELSOLIC INT PRIMARY KEY AUTO_INCREMENT,
	IDSOLIC INT NOT NULL,
	DATASOLIC DATE NOT NULL,
	ID_FUNC INT NOT NULL,
	ID_AGENCIA INT NOT NULL,
	ID_VAL INT,
	JUSTIFICATIVA VARCHAR(140) NOT NULL,
	TIPO ENUM('1', '2', '3') NOT NULL,
	DTINICIO DATE NOT NULL,
	DTFIM DATE NOT NULL
	);

CREATE TABLE APROVNEG(
	IDAPROVNEG INT PRIMARY KEY AUTO_INCREMENT,
	IDAPROV INT NOT NULL,
	ID_SOLIC INT NOT NULL,
	VALOR INT NOT NULL,
	APROV ENUM('S','N','P') NOT NULL DEFAULT 'P' /* S = Sim // N = Não // P = Pendente */
	);

CREATE TABLE APROVAPR(
	IDAPROVAPR INT PRIMARY KEY AUTO_INCREMENT,
	IDAPROV INT NOT NULL,
	ID_SOLIC INT NOT NULL,
	VALOR INT NOT NULL,
	APROV ENUM('S','N','P') NOT NULL DEFAULT 'P' /* S = Sim // N = Não // P = Pendente */
	);

DELIMITER $	
    
CREATE TRIGGER SOLICDELETADAS
AFTER DELETE ON SOLICITA
FOR EACH ROW
BEGIN
	INSERT INTO DELSOLIC VALUES(NULL, OLD.IDSOLIC, OLD.DATASOLIC, OLD.ID_FUNC, OLD.ID_AGENCIA, OLD.ID_VAL, OLD.JUSTIFICATIVA, OLD.TIPO, OLD.DTINICIO, OLD.DTFIM);
END$

CREATE PROCEDURE HISTDELSOLIC(EMAIL VARCHAR(50), SENHA1 VARCHAR(100))
BEGIN
	DECLARE IDFUNC1 INT;
	SET IDFUNC1 = ( 
		SELECT IDFUNC FROM FUNCIONARIO
		WHERE EMAIL = EMAIL1 AND SENHA = SENHA1);
	SELECT * FROM DELSOLIC WHERE ID_FUNC = IDFUNC1;
END$


/*DELIMITER $	
CREATE TRIGGER EMITIRPASS           
AFTER UPDATE ON APROVACAO
FOR EACH ROW
BEGIN
	DECLARE EMAIL1 VARCHAR(50);
    SET EMAIL1 = (SELECT EMAIL FROM SOLICITA
						JOIN FUNCIONARIO
						ON ID_FUNC = IDFUNC
						WHERE IDSOLIC = OLD.ID_SOLIC);
	DECLARE SENHA1 VARCHAR(100);
    SET SENHA1 = (	SELECT SENHA FROM SOLICITA
						JOIN FUNCIONARIO
						ON ID_FUNC = IDFUNC
						WHERE IDSOLIC = OLD.ID_SOLIC);				
	IF ( 'N' = (NEW.APROV))
	THEN
		CALL DELETASOLICITA(EMAIL1, SENHA1, OLD.ID_SOLIC)
	END IF;
END$*/
