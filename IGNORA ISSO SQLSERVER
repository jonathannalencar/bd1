CREATE TABLE ALUNO(
	IDALUNO	INT PRIMARY KEY IDENTITY,
	NOME VARCHAR(30) NOT NULL,
	SEXO CHAR(1) NOT NULL,
	NASCIMENTO DATE NOT NULL,
	EMAIL VARCHAR(30) UNIQUE
	)
GO

ALTER TABLE ALUNO
ADD CONSTRAINT CK_SEXO
CHECK (SEXO IN ('M','F'))
GO

CREATE TABLE ENDERECO(
	IDENDERECO INT PRIMARY KEY IDENTITY(100,10),
	BAIRRO VARCHAR(30) NOT NULL,
	UF CHAR(2) NOT NULL
	CHECK (UF IN ('RJ','SP','MG')),
	ID_ALUNO INT UNIQUE
	)
	
GO

ALTER TABLE ENDERECO
ADD CONSTRAINT FK_ENDERECO_ALUNO
FOREIGN KEY (ID_ALUNO)
REFERENCES ALUNO(IDALUNO)

GO

SP_COLUMNS ALUNO
GO

SP_HELP ALUNO
GO

INSERT INTO ALUNO VALUES ('ANDRE','M','1981/12/09','ANDRE@IG.COM')
INSERT INTO ALUNO VALUES ('ANA','M','1978/03/09','ANA@IG.COM')
INSERT INTO ALUNO VALUES ('RUI','M','1951/07/09','RUI@IG.COM')
INSERT INTO ALUNO VALUES ('JOAO','M','2008/11/09','JOAO@IG.COM')
GO

INSERT INTO ENDERECO VALUES ('FLAMENGO','RJ',1)
INSERT INTO ENDERECO VALUES ('MORUMBI','SP',2)
INSERT INTO ENDERECO VALUES ('CENTRO','MG',3)
INSERT INTO ENDERECO VALUES ('CENTRO','SP',4)
GO

CREATE TABLE  TELEFONE(
	IDTELEFONE INT PRIMARY KEY IDENTITY,
	TIPO CHAR(3) NOT NULL,
	NUMERO VARCHAR(10) NOT NULL,
	ID_ALUNO INT,
	CHECK (TIPO IN('RES','COM','CEL'))
	)
GO

INSERT INTO TELEFONE VALUES('CEL','84729387',1)
INSERT INTO TELEFONE VALUES('RES','48621594',1)
INSERT INTO TELEFONE VALUES('COM','76513849',2)
INSERT INTO TELEFONE VALUES('CEL','91354861',2)
GO

SELECT GETDATE()
GO

SELECT NOME, ISNULL(TIPO,'---') AS TIPO, ISNULL(NUMERO,'---') AS NUMERO, BAIRRO, UF FROM ALUNO
LEFT JOIN TELEFONE AS T
ON IDALUNO = T.ID_ALUNO
INNER JOIN ENDERECO AS E
ON IDALUNO = E.ID_ALUNO
GO

SELECT NOME, DATEDIFF(DAY, NASCIMENTO, GETDATE())/365 AS IDADE FROM ALUNO
GO

SELECT NOME, DATEDIFF(MONTH, NASCIMENTO, GETDATE())/12 AS IDADE FROM ALUNO
GO

SELECT NOME, DATEDIFF(YEAR, NASCIMENTO, GETDATE()) AS IDADE FROM ALUNO
GO

SELECT NOME, DATENAME(MONTH, NASCIMENTO) AS MES FROM ALUNO
GO

SELECT NOME, DATENAME(WEEKDAY, NASCIMENTO) AS MES FROM ALUNO
GO

SELECT NOME, DATEPART(MONTH, NASCIMENTO) FROM ALUNO
GO

SELECT NOME, DATEPART(MONTH, NASCIMENTO), DATENAME(MONTH, NASCIMENTO) FROM ALUNO
GO

SELECT DATEADD(DAY,365,GETDATE())
GO

SELECT 1 * '1'
GO

SELECT NOME, CAST(DAY(NASCIMENTO) AS VARCHAR)+'/'+CAST(MONTH(NASCIMENTO) AS VARCHAR)+'/'+CAST(YEAR(NASCIMENTO) AS VARCHAR) AS NASCIMENTO FROM ALUNO
GO

SELECT NOME, CHARINDEX('A',NOME) as INDICE FROM ALUNO
GO

SELECT NOME, CHARINDEX('A',NOME,2) as INDICE FROM ALUNO
GO

CREATE TABLE LANCAMENTO_CONTABIL(
	CONTA INT,
	VALOR INT,
	DEB_CRED CHAR(1)
	)
GO

SELECT * FROM LANCAMENTO_CONTABIL
GO

BULK INSERT LANCAMENTO_CONTABIL
FROM 'C:\Users\x04150004242\Desktop\CONTAS.txt'
WITH(
	FIRSTROW = 2,
	DATAFILETYPE = 'char',
	FIELDTERMINATOR = '\t',
	ROWTERMINATOR = '\n'
	)
GO

SELECT * FROM LANCAMENTO_CONTABIL
GO

SELECT CONTA, SUM(VALOR*(CHARINDEX('C',DEB_CRED)*2-1)) FROM LANCAMENTO_CONTABIL
GROUP BY CONTA

GO

CREATE TABLE PRODUTOS(
	IDPRODUTO INT IDENTITY PRIMARY KEY,
	NOME VARCHAR(50) NOT NULL,
	CATEGORIA VARCHAR(30) NOT NULL,
	PRECO NUMERIC(10,2) NOT NULL
	)
GO

CREATE TABLE HISTORICO(
	IDOPERACAO INT PRIMARY KEY IDENTITY,
	PRODUTO VARCHAR(50) NOT NULL,
	CATEGORIA VARCHAR(30) NOT NULL,
	PRECOANTIGO NUMERIC(10,2) NOT NULL,
	PRECONOVO NUMERIC(10,2) NOT NULL,
	DATA DATETIME,
	USUARIO VARCHAR(30),
	MENSAGEM VARCHAR(100)
	)
GO

INSERT INTO PRODUTOS VALUES ('LIVRO SQL SERVER', 'LIVROS', 98.00)
INSERT INTO PRODUTOS VALUES ('LIVRO ORACLE', 'LIVROS', 50.00)
INSERT INTO PRODUTOS VALUES ('LICENCA POWERCENTER', 'SOFTEWARES', 45000.00)
INSERT INTO PRODUTOS VALUES ('NOTEBOOK I7', 'COMPUTADORES', 3150.00)
INSERT INTO PRODUTOS VALUES ('LIVRO BI', 'LIVROS', 90.00)
GO

SELECT * FROM PRODUTOS
SELECT * FROM HISTORICO
GO

SELECT SUSER_NAME()
GO

CREATE TRIGGER TRG_ATUALIZA_PRECO
ON DBO.PRODUTOS
FOR UPDATE
AS
	DECLARE @IDPRODUTO INT
	DECLARE @PRODUTO VARCHAR(30)
	DECLARE @CATEGORIA VARCHAR(10)
	DECLARE @PRECO NUMERIC(10,2)
	DECLARE @PRECONOVO NUMERIC(10,2)
	DECLARE @DATA DATETIME
	DECLARE	@USUARIO VARCHAR(30)
	DECLARE @ACAO VARCHAR(100)
	
	SELECT @IDPRODUTO = IDPRODUTO FROM inserted
	SELECT @PRODUTO = NOME FROM inserted
	SELECT @CATEGORIA = CATEGORIA FROM inserted
	SELECT @PRECO = PRECO FROM deleted
	SELECT @PRECONOVO = PRECO FROM inserted
	SET @DATA = GETDATE()
	SET @USUARIO = SUSER_ID()
	SET @ACAO = 'VALOR INSERIDO PELA TRIGGER TRG_ATUALIZA_PRECO'

	INSERT INTO HISTORICO (PRODUTO, CATEGORIA, PRECOANTIGO, PRECONOVO, DATA, USUARIO, MENSAGEM) VALUES
	(@PRODUTO, @CATEGORIA, @PRECO, @PRECONOVO, @DATA, @USUARIO, @ACAO)

	PRINT 'TRIGGER EXECUTADA COM SUCESSO'
GO

UPDATE PRODUTOS SET PRECO = 100.00
WHERE IDPRODUTO = 1
GO

SELECT * FROM PRODUTOS
SELECT * FROM HISTORICO
GO

UPDATE PRODUTOS SET NOME = 'LIVRO C#'
WHERE IDPRODUTO = 1
GO

DROP TRIGGER TRG_ATUALIZA_PRECO
GO

CREATE TRIGGER TRG_ATUALIZA_PRECO
ON DBO.PRODUTOS
FOR UPDATE
AS
IF UPDATE(PRECO)
BEGIN
	DECLARE @IDPRODUTO INT
	DECLARE @PRODUTO VARCHAR(30)
	DECLARE @CATEGORIA VARCHAR(10)
	DECLARE @PRECO NUMERIC(10,2)
	DECLARE @PRECONOVO NUMERIC(10,2)
	DECLARE @DATA DATETIME
	DECLARE	@USUARIO VARCHAR(30)
	DECLARE @ACAO VARCHAR(100)
	
	SELECT @IDPRODUTO = IDPRODUTO FROM inserted
	SELECT @PRODUTO = NOME FROM inserted
	SELECT @CATEGORIA = CATEGORIA FROM inserted
	SELECT @PRECO = PRECO FROM deleted
	SELECT @PRECONOVO = PRECO FROM inserted
	SET @DATA = GETDATE()
	SET @USUARIO = SUSER_ID()
	SET @ACAO = 'VALOR INSERIDO PELA TRIGGER TRG_ATUALIZA_PRECO'

	INSERT INTO HISTORICO (PRODUTO, CATEGORIA, PRECOANTIGO, PRECONOVO, DATA, USUARIO, MENSAGEM) VALUES
	(@PRODUTO, @CATEGORIA, @PRECO, @PRECONOVO, @DATA, @USUARIO, @ACAO)

	PRINT 'TRIGGER EXECUTADA COM SUCESSO'
END
GO

UPDATE PRODUTOS SET PRECO = 300.00
WHERE IDPRODUTO = 2
GO

SELECT * FROM PRODUTOS
SELECT * FROM HISTORICO
GO

UPDATE PRODUTOS SET NOME = 'LIVRO JAVA'
WHERE IDPRODUTO = 2
GO

SELECT * FROM PRODUTOS
SELECT * FROM HISTORICO
GO

CREATE TABLE EMPREGADO(
	IDEMO INT PRIMARY KEY IDENTITY,
	NOME VARCHAR(30),
	SALARIO MONEY,
	IDGERENTE INT
	)
GO

ALTER TABLE EMPREGADO
ADD CONSTRAINT FK_GERENTE
FOREIGN KEY (IDGERENTE)
REFERENCES EMPREGADO(IDEMO)
GO

INSERT INTO EMPREGADO VALUES ('CLARA', 5000.00, NULL)
INSERT INTO EMPREGADO VALUES ('CELIA', 4000.00, 1)
INSERT INTO EMPREGADO VALUES ('JOAO', 4000.00, 1)
GO

SELECT * FROM EMPREGADO
GO

CREATE TABLE HIST_SALARIO(
	IDEMPREGADO INT,
	ANTIGOSAL MONEY,
	NOVOSAL MONEY,
	DATA DATETIME
	)
GO

CREATE TRIGGER TG_SALARIO
ON DBO.EMPREGADO
FOR UPDATE AS
IF UPDATE(SALARIO)
BEGIN
	INSERT INTO HIST_SALARIO (IDEMPREGADO, ANTIGOSAL, NOVOSAL, DATA)
	SELECT D.IDEMO, D.SALARIO, I.SALARIO, GETDATE()
	FROM DELETED D, inserted I
	WHERE D.IDEMO=I.IDEMO
END
GO

UPDATE EMPREGADO SET SALARIO = SALARIO*1.1
GO

SELECT NOME, ANTIGOSAL, NOVOSAL, DATA FROM HIST_SALARIO
INNER JOIN EMPREGADO
ON IDEMO = IDEMPREGADO
GO

SELECT * FROM EMPREGADO
GO

CREATE TABLE SALARIO_RANGE(
	MINSAL MONEY,
	MAXSAL MONEY
	)
GO

INSERT INTO SALARIO_RANGE VALUES(3000.00, 6000.00)
GO

CREATE TRIGGER TG_RANGE
ON DBO.EMPREGADO
FOR INSERT, UPDATE
AS
	DECLARE
		@MINSAL MONEY,
		@MAXSAL MONEY,
		@ATUALSAL MONEY

	SELECT @MINSAL = MINSAL, @MAXSAL = MAXSAL FROM SALARIO_RANGE

	SELECT @ATUALSAL = I.SALARIO
	FROM INSERTED I

	IF(@ATUALSAL<@MINSAL)
	BEGIN
		RAISERROR('SALARIO MENOR QUE O PISO', 16,1)
		ROLLBACK TRANSACTION
	END
	
	IF(@ATUALSAL>@MAXSAL)
	BEGIN
		RAISERROR('SALARIO MAIOR QUE O TETO', 16,1)
		ROLLBACK TRANSACTION
	END
GO

SELECT * FROM SALARIO_RANGE
GO

UPDATE EMPREGADO SET SALARIO = 9000.00
WHERE IDEMO = 1
GO

UPDATE EMPREGADO SET SALARIO = 2000.00
WHERE IDEMO = 1
GO

SP_HELPTEXT TG_RANGE
GO

CREATE TABLE PESSOA(
	IDPESSOA INT PRIMARY KEY IDENTITY,
	NOME VARCHAR(30) NOT NULL,
	SEXO CHAR(1) NOT NULL CHECK (SEXO IN ('M','F')),
	NASCIMENTO DATE NOT NULL
	)
GO

DROP TABLE TELEFONE
CREATE TABLE TELEFONE(
	IDTELEFONE INT PRIMARY KEY IDENTITY,
	TIPO CHAR(3) NOT NULL CHECK (TIPO IN ('CEL','RES','COM')),
	NUMERO CHAR(10) NOT NULL,
	ID_PESSOA INT
	)
GO

ALTER TABLE TELEFONE
ADD CONSTRAINT FK_TELEFONE
FOREIGN KEY (ID_PESSOA)
REFERENCES PESSOA(IDPESSOA)
GO

INSERT INTO PESSOA VALUES('ANTONIO','M','1981/02/13')
INSERT INTO PESSOA VALUES('DANIEL','M','1985/03/18')
INSERT INTO PESSOA VALUES('CLEIDE','F','1979/10/13')

INSERT INTO TELEFONE VALUES('CEL', '946852167',8)
INSERT INTO TELEFONE VALUES('COM', '84621654',8)
INSERT INTO TELEFONE VALUES('CEL', '964813548',9)
INSERT INTO TELEFONE VALUES('CEL', '948135746',9)
INSERT INTO TELEFONE VALUES('COM', '84456213',10)
INSERT INTO TELEFONE VALUES('COM', '94681357',9)
INSERT INTO TELEFONE VALUES('CEL', '948621578',10)

SELECT * FROM TELEFONE
SELECT * FROM PESSOA
GO

DELETE FROM TELEFONE
DELETE FROM PESSOA
GO

