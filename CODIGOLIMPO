CREATE DATABASE  IF NOT EXISTS agencia;
USE agencia;

DROP TABLE IF EXISTS agencia_viagem;
CREATE TABLE agencia_viagem(
  ID_AGENC INT(11) PRIMARY KEY AUTO_INCREMENT,
  NOME_AGENC VARCHAR(50) NOT NULL,
  CNPJ VARCHAR(30) UNIQUE NOT NULL
);

DROP TABLE IF EXISTS departamento;
CREATE TABLE departamento(
  IDDEP INT(11) PRIMARY KEY AUTO_INCREMENT,
  NOMEDEP VARCHAR(50) NOT NULL,
  ORCAMENTO INT(11) NOT NULL,
  CENTRO_CUSTO INT(11) NOT NULL,
  ID_GERENTE INT(11)													/*--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 23/10-- ADICIONEI ESSA COLUNA */
);

DROP TABLE IF EXISTS funcionario;
CREATE TABLE funcionario(
  IDFUNC INT(11) PRIMARY KEY AUTO_INCREMENT,
  PRONTUARIO INT(11) UNIQUE NOT NULL,
  NOMEFUNC VARCHAR(50) NOT NULL,
  EMAIL VARCHAR(50) UNIQUE NOT NULL,
  SENHA VARCHAR(100) NOT NULL,
  CPF VARCHAR(11) UNIQUE NOT NULL,
  ID_DEP INT(11) DEFAULT NULL,
  CARGO VARCHAR(30) NOT NULL,
  PERFIL VARCHAR(30) DEFAULT 'USUARIO',
  SEXO ENUM('Masculino','Feminino') NOT NULL							/*------------------------------------------------------------------------------------------------------ 23/10 -- MUDEI DE VARCHAR(20) PARA ENUM, TEORICAMENTE N MUDA NADA NA EXECUCAO, SÓ TE IMPEDE DE ESCOLHER OUTRO SEXO ALEM DE MASCULINO E FEMININO (NÃO, ISSO NAO É UMA ATITUDE MACHISTA, SÓ ESTOU EVITANDO BUGS E VAI TOMAR NO CU */
);

DROP TABLE IF EXISTS solicita_aerea;
CREATE TABLE solicita_aerea(
  ID_SOLICITA_AEREA INT(11) PRIMARY KEY AUTO_INCREMENT,
  DATA_IDA VARCHAR(50) NOT NULL,
  DATA_VOLTA VARCHAR(50) NOT NULL,
  ORIGEM VARCHAR(50) NOT NULL,
  DESTINO VARCHAR(50) NOT NULL,
  ID_SOLICITAA_FUNC INT(11) NOT NULL,
  ID_SOLICITA_VALOR INT(11) NOT NULL
);

DROP TABLE IF EXISTS solicita_hospedagem;
CREATE TABLE solicita_hospedagem(
  ID_SOLICITA_HOSPEDAGEM INT(11) PRIMARY KEY AUTO_INCREMENT,
  DATA_ENTRADA VARCHAR(50) NOT NULL,
  DATA_SAIDA VARCHAR(50) NOT NULL,
  DESTINO_HOTEL VARCHAR(50) NOT NULL,
  ID_SOLICITAH_FUNC INT(11) NOT NULL,
  ID_SOLICITA_VALOR INT(11) NOT NULL
);

DROP TABLE IF EXISTS solicita_locacao;
CREATE TABLE solicita_locacao(
  ID_SOLICITA_LOCACAO INT(11) PRIMARY KEY AUTO_INCREMENT,
  DATA_ENTRADA VARCHAR(50) NOT NULL,
  DATA_SAIDA VARCHAR(50) NOT NULL,
  CIDADE_RETIRADA VARCHAR(50) NOT NULL,
  ID_SOLICITAL_FUNC INT(11) NOT NULL,
  ID_SOLICITA_VALOR INT(11) NOT NULL
);

DROP TABLE IF EXISTS valor;
CREATE TABLE valor(
  ID_VALOR INT(11) PRIMARY KEY AUTO_INCREMENT,
  VALOR INT(11) NOT NULL,
  DATA_SOLICITACAO VARCHAR(50) NOT NULL,
  NOME_TIPO VARCHAR(50) NOT NULL,
  ID_VALOR_FUNC INT(11) NOT NULL,
  APROVADO VARCHAR(10) NOT NULL
);

/* ------ 23/10 -- INICIO DAS DECLARACOES DAS CHAVES ESTRANGEIRAS --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- */

ALTER TABLE funcionario	
ADD CONSTRAINT FK_FUNC_DEP
FOREIGN KEY (ID_DEP)
REFERENCES departamento(IDDEP); 

ALTER TABLE solicita_aerea
ADD CONSTRAINT FK_AEREA_FUNC
FOREIGN KEY (ID_SOLICITAA_FUNC)
REFERENCES funcionario(IDFUNC);

ALTER TABLE solicita_hospedagem
ADD CONSTRAINT FK_HOSPE_FUNC
FOREIGN KEY (ID_SOLICITAH_FUNC)
REFERENCES funcionario(IDFUNC);

ALTER TABLE solicita_locacao
ADD CONSTRAINT FK_LOCAC_FUNC
FOREIGN KEY (ID_SOLICITAL_FUNC)
REFERENCES funcionario(IDFUNC);

ALTER TABLE solicita_aerea
ADD CONSTRAINT FK_AEREA_VAL
FOREIGN KEY (ID_SOLICITA_VALOR)
REFERENCES valor(IDVALOR);

ALTER TABLE solicita_hospedagem
ADD CONSTRAINT FK_HOSPE_VAL
FOREIGN KEY (ID_SOLICITA_VALOR)
REFERENCES valor(IDVALOR);

ALTER TABLE solicita_locacao
ADD CONSTRAINT FK_LOCAC_VAL
FOREIGN KEY (ID_SOLICITA_VALOR)
REFERENCES valor(IDVALOR);

/* ------ 23/10 -- FIM DAS DECLARACOES DAS CHAVES ESTRANGEIRAS --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- */


INSERT INTO agencia_viagem VALUES (1,'ViagemEmpresarial','15.014.547/022196');
INSERT INTO departamento (IDDEP, NOMEDEP, ORCAMENTO, CENTRO_CUSTO) VALUES (1,'diretoria',15000,1054600),(2,'ti',15000,1054830),(3,'sac',15000,1054800),(4,'sustentabilidade',15000,1054800);
INSERT INTO funcionario VALUES (1,350534,'christian brandao','christian.lasa@lasa.com.br','#lasa2021','16530244700',2,'ADM','ADMINISTRADOR','Masculino'),(2,155623,'eduarda','eduarda.nunes12@gmail.com','123456','15612529724',1,'diretora','USUARIO','Feminino'),(3,564738,'jonathan neves alencar','jonathannalencar@gmail.com','senha123','04145050467',2,'chefao da porra toda','ADMINSITRADOR','Masculino'),(4,274652,'luis felipe da silva souza','luisp1927@hotmail.com','22304106','27645376654',1,'ESTAGIARIO','USUARIO','Masculino');
INSERT INTO valor VALUES (17,560,'17/10/2019 09:38:06','LOCACAO',3,'PENDENTE'),(16,1525,'17/10/2019 09:36:36','AEREO',3,'NAO'),(3,1700,'17/10/2019 01:03:52','AEREO',1,'NAO'),(4,240,'17/10/2019 01:47:04','LOCACAO',1,'NAO'),(5,660,'17/10/2019 01:47:33','HOSPEDAGEM',1,'NAO'),(6,1525,'17/10/2019 01:47:56','AEREO',1,'NAO'),(7,720,'17/10/2019 01:48:31','LOCACAO',1,'NAO'),(8,0,'17/10/2019 01:49:06','HOSPEDAGEM',1,'NAO'),(9,0,'17/10/2019 01:49:09','HOSPEDAGEM',1,'NAO'),(10,0,'17/10/2019 01:49:11','HOSPEDAGEM',1,'NAO'),(11,0,'17/10/2019 01:49:12','HOSPEDAGEM',1,'NAO'),(12,0,'17/10/2019 01:49:14','HOSPEDAGEM',1,'NAO'),(13,0,'17/10/2019 01:49:16','HOSPEDAGEM',1,'NAO'),(14,0,'17/10/2019 01:49:18','HOSPEDAGEM',1,'NAO'),(15,0,'17/10/2019 01:49:20','HOSPEDAGEM',1,'NAO'),(18,560,'17/10/2019 09:39:15','LOCACAO',3,'PENDENTE'),(19,1700,'17/10/2019 09:41:08','AEREO',3,'PENDENTE'),(20,40260,'17/10/2019 10:26:26','HOSPEDAGEM',4,'PENDENTE');
INSERT INTO solicita_aerea VALUES (1,'10/11/2019','15/11/2019','rio de janeiro','salvador',1,3),(2,'10/05/2019','20/05/2019','rio de janeiro','chile',1,6),(3,'10/05/2019','11/05/2019','rio de janeiro','chile',1,16),(4,'18/10/2019','30/10/2019','rio de janeiro','chile',3,16),(5,'10/05/2019','20/05/2019','rio de janeiro','salvador',3,19);
INSERT INTO solicita_hospedagem VALUES (1,'10/10/2019','15/10/2019','rio de janeiro',1,2),(2,'10/05/2019','16/05/2019','ilha grande',1,5),(3,'10/01/1000','10/01/1000','teste',1,8),(4,'10/01/1000','10/01/1000','teste',1,9),(5,'10/01/1000','10/01/1000','teste',1,10),(6,'10/01/1000','10/01/1000','teste',1,11),(7,'10/01/1000','10/01/1000','teste',1,12),(8,'10/01/1000','10/01/1000','teste',1,13),(9,'10/01/1000','10/01/1000','teste',1,14),(10,'10/01/1000','10/01/1000','teste',1,15),(11,'17/10/2019','17/10/2020','rio de janeiro',4,20);
INSERT INTO solicita_locacao VALUES (1,'18/10/2019','25/10/2019','rio de janeiro',3,18);

DELIMITER ;;

CREATE PROCEDURE ALTERASENHA(IDFUNC1 INT, SENHAANT VARCHAR(100), SENHANOVA VARCHAR(100))
BEGIN
	IF (SENHAANT IN (SELECT SENHA FROM FUNCIONARIO WHERE IDFUNC = IDFUNC1))
	THEN
        UPDATE FUNCIONARIO SET SENHA = SENHANOVA WHERE IDFUNC = IDFUNC1;
	END IF;
END ;;
CREATE PROCEDURE TABLEAPROVACAO(IDDEP1 INT)
BEGIN
	SELECT ID_VALOR, F.NOMEFUNC, NOME_TIPO, VALOR FROM VALOR 
    JOIN FUNCIONARIO AS F 
    ON IDFUNC = ID_VALOR_FUNC
	WHERE ID_DEP = IDDEP1 AND APROVADO = 'PENDENTE';
END ;;

CREATE PROCEDURE TABLEAPROVACAOADM()
BEGIN
	SELECT ID_VALOR, F.NOMEFUNC, NOME_TIPO, VALOR FROM VALOR 
    JOIN FUNCIONARIO AS F 
    ON IDFUNC = ID_VALOR_FUNC
	WHERE APROVADO = 'PENDENTE';
END ;;

DELIMITER ;

